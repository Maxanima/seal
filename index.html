<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Магическая печать — Сферы + Mock</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100vw;
    background: #000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  body {
    min-height: 100vh;
    text-align: center;
    padding: 0;
    box-sizing: border-box;
    width: 100vw;
  }
  #top-bar {
    position: fixed;
    top: 0; left: 0; width: 100vw;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: space-between;
    pointer-events: none;
    height: 56px;
    background: none;
  }
  #player-info {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.5);
    color: #eee;
    font-size: 15px;
    border-radius: 6px;
    padding: 6px 10px;
    margin-left: 12px;
    pointer-events: auto;
    height: 40px;
  }
  #avatar-btn {
    width: 36px; height: 36px; border-radius: 50%; border: 2px solid #4e54c8;
    overflow: hidden; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
    margin-right: 4px;
    flex-shrink: 0;
  }
  #avatar-btn img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
  }
  #sphere-counter {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #eee;
    font-weight: 600;
    font-size: 22px;
    margin-right: 12px;
    background: rgba(0,0,0,0.5);
    border-radius: 6px;
    padding: 6px 12px;
    pointer-events: auto;
    height: 40px;
  }
  #sphere-counter svg {
    width: 30px;
    height: 30px;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
    flex-shrink: 0;
  }
  #mining-btn {
    position: fixed; top: 62px; right: 24px;
    background: linear-gradient(90deg,#34c759,#00b894); color: #fff; font-size: 0.93rem; font-weight: 700;
    border: none; border-radius: 9px; padding: 5px 0; width: 74px; text-align: center;
    box-shadow: 0 2px 12px #34c75966; cursor: pointer; z-index: 21; border-bottom: 2px solid #fff3;
  }
  #mining-btn[disabled] {
    background: #444; color: #aaa; filter: grayscale(0.5) brightness(0.8); cursor: default; border-bottom: 2px solid #222;
  }
  #seal-balance {
    position: fixed;
    top: 56px; left: 50%; transform: translateX(-50%);
    color: #fff;
    font-size: 1.1rem;
    font-weight: 800;
    letter-spacing: 1.1px;
    text-shadow: 0 2px 12px #00ff88, 0 0 2px #fff;
    z-index: 20;
    background: rgba(0,0,0,0.18);
    border-radius: 10px;
    padding: 5px 14px 5px 10px;
    min-width: 90px;
    text-align: center;
    box-sizing: border-box;
    user-select: none;
    width: max-content;
    pointer-events: none;
    border: 2px solid #00ff88;
    filter: drop-shadow(0 0 5px #00ff88);
  }
  #canvas-container {
    position: fixed;
    left: 0; right: 0;
    top: 100px; /* ниже top-bar + seal-balance */
    bottom: 70px; /* выше bottom-nav */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    background: none;
    overflow: visible;
  }
  canvas {
    display: block;
    background: transparent;
    border-radius: 0;
    box-sizing: border-box;
    touch-action: manipulation;
    image-rendering: auto;
    z-index: 1;
    pointer-events: none;
    margin: auto;
  }
  #rare-message {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 90px;
    color: #00ff88;
    font-size: 17px;
    font-weight: bold;
    font-family: monospace;
    text-shadow: 0 0 8px #00ff88;
    text-align: center;
    white-space: pre-line;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 19;
    background: none;
    border: none;
    box-shadow: none;
    min-width: 0;
    padding: 0;
  }
  #rare-message.active { opacity: 1; }
  #bottom-nav {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
    z-index: 10;
    background: none;
  }
  .nav-btn {
    background: #111;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 14px;
    cursor: pointer;
    user-select: none;
  }
  .tab {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: #111;
    color: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px #0ff3;
    z-index: 20;
    display: none;
  }
  .tab h2 { margin-top: 0; }
  .close-btn {
    display: inline-block;
    margin-top: 10px;
    background: #222;
    color: #fff;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #profile-tab img {
    width: 60px; height: 60px; border-radius: 50%; border: 2px solid #4e54c8;
  }
  #mock-payment-modal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #111;
    border-radius: 14px;
    box-shadow: 0 0 30px #0ff;
    padding: 20px;
    color: #0ff;
    font-family: monospace;
    width: 320px;
    z-index: 30;
    display: none;
  }
  #mock-payment-modal button {
    background: #0ff;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    font-weight: 700;
    user-select: none;
  }
  #mock-payment-result {
    margin-top: 10px;
    font-weight: 700;
  }
</style>
</head>
<body>

<div id="top-bar">
  <div id="player-info">
    <button id="avatar-btn" title="Профиль">
      <img src="https://i.pravatar.cc/100?u=sealuser" alt="Avatar"/>
    </button>
    <span>Level: <span id="level">1</span> | XP: <span id="xp">0</span>/100</span>
  </div>
  <div id="sphere-counter">
    <svg viewBox="0 0 64 64" fill="none" stroke="white" stroke-width="2" stroke-linejoin="round" stroke-linecap="round">
      <circle cx="32" cy="32" r="30" />
      <circle cx="32" cy="32" r="20" />
      <circle cx="32" cy="32" r="10" />
    </svg>
    <span id="sphere-count">100</span>
  </div>
</div>

<button id="mining-btn">Mining</button>
<div id="seal-balance">$SEAL: <span id="seal-amount">0.000</span></div>

<div id="canvas-container" tabindex="0">
  <canvas id="sealCanvas"></canvas>
</div>
<div id="rare-message"></div>

<div id="bottom-nav">
  <button class="nav-btn" onclick="openTab('shop-tab')">Shop</button>
  <button class="nav-btn" onclick="openTab('quests-tab')">Quests</button>
  <button class="nav-btn" onclick="openTab('friends-tab')">Friends</button>
</div>

<div id="shop-tab" class="tab">
  <h2>Shop</h2>
  <ul>
    <li>10 сфер — 5 TON <button onclick="startMockPayment(10)">Купить</button></li>
    <li>25 сфер — 10 TON <button onclick="startMockPayment(25)">Купить</button></li>
    <li>50 сфер — 18 TON <button onclick="startMockPayment(50)">Купить</button></li>
    <li>100 сфер — 30 TON <button onclick="startMockPayment(100)">Купить</button></li>
    <li>250 сфер — 60 TON <button onclick="startMockPayment(250)">Купить</button></li>
    <li>500 сфер — 100 TON <button onclick="startMockPayment(500)">Купить</button></li>
  </ul>
  <button class="close-btn" onclick="closeTabs()">Close</button>
</div>

<div id="quests-tab" class="tab">
  <h2>Quests</h2>
  <ul>
    <li>Сделай 10 генераций — 10 XP</li>
    <li>Собери 4 одинаковых фигуры — 10 XP</li>
    <li>3 совпадения по цвету — 10 XP</li>
  </ul>
  <button class="close-btn" onclick="closeTabs()">Close</button>
</div>

<div id="friends-tab" class="tab">
  <h2>Friends</h2>
  <p>Приглашённые друзья:</p>
  <ul><li>Пока никого...</li></ul>
  <p>Рейтинг по уровню:</p>
  <ul><li>Игрок1 — Уровень 12</li><li>Игрок2 — Уровень 9</li></ul>
  <button class="close-btn" onclick="closeTabs()">Close</button>
</div>

<div id="profile-tab" class="tab">
  <h2>Profile</h2>
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
    <img src="https://i.pravatar.cc/100?u=sealuser" alt="Avatar">
    <div>
      <div style="font-weight:700;font-size:17px;color:#fff;">Seal User</div>
      <div style="font-size:13px;color:#ccc;">Level: <span id="profile-level">1</span></div>
    </div>
  </div>
  <ul id="rare-stats" style="font-size:15px;line-height:1.7;">
    <!-- Заполняется скриптом -->
  </ul>
  <button class="close-btn" onclick="closeTabs()">Close</button>
</div>

<div id="mock-payment-modal">
  <h3>Mock Payment</h3>
  <p>Вы покупаете <span id="mock-payment-amount">0</span> сфер.</p>
  <button id="confirm-payment-btn">Подтвердить</button>
  <button class="close-btn" onclick="closeMockPayment()">Отмена</button>
  <p id="mock-payment-result"></p>
</div>

<script>
(() => {
  function resizeCanvas() {
    const canvas = document.getElementById('sealCanvas');
    // Квадратный canvas, максимум между панелями
    const topSpace = 100; // top-bar + seal-balance + mining
    const bottomSpace = 90; // bottom-nav + запас
    const avail = Math.min(window.innerWidth, window.innerHeight - topSpace - bottomSpace);
    const dpr = window.devicePixelRatio || 1;
    canvas.width = avail * dpr;
    canvas.height = avail * dpr;
    canvas.style.width = avail + 'px';
    canvas.style.height = avail + 'px';
    return {size: avail, dpr};
  }
  window.addEventListener('resize', resizeCanvas);

  const colors = ['#1E90FF', '#00FFFF', '#7FFF00', '#FF69B4', '#FFD700', '#FF4500'];
  const figureTypes = ['circle', 'equilateralTriangle', 'square'];
  const sizeRange = [160, 190, 220, 250];
  const rotationSpeeds = [0.002, 0.004, 0.006, 0.008];

  const CHANCES = {
    rare: '2%',
    mythic: '0.5%',
    legendary: '0.2%',
    ethereal: '0.02%'
  };

  let spheres = 100, xp = 0, level = 1, seal = 0.000;
  let statTotal = 0, rare = 0, mythic = 0, legendary = 0, ethereal = 0;
  let sealFigures = [];

  const canvas = document.getElementById('sealCanvas');
  const ctx = canvas.getContext('2d');
  const container = document.getElementById('canvas-container');
  const rareMessageEl = document.getElementById('rare-message');
  const sealBalanceEl = document.getElementById('seal-amount');
  const rareStatsEl = document.getElementById('rare-stats');
  const xpEl = document.getElementById('xp');
  const levelEl = document.getElementById('level');
  const profileLevelEl = document.getElementById('profile-level');
  const miningBtn = document.getElementById('mining-btn');
  let miningCooldown = 0;

  function drawShape(ctx, type, x, y, size, color, rotation, glowAlpha, dpr) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotation);
    ctx.lineWidth = 7 * dpr;
    ctx.strokeStyle = color;
    ctx.shadowColor = color;
    ctx.shadowBlur = 30 * glowAlpha * dpr;
    ctx.beginPath();
    if (type === 'circle') ctx.arc(0, 0, size / 2, 0, Math.PI * 2);
    else if (type === 'equilateralTriangle') {
      for (let i = 0; i < 3; i++) {
        const angle = i * 2 * Math.PI / 3 - Math.PI / 2;
        const px = (size / Math.sqrt(3)) * Math.cos(angle);
        const py = (size / Math.sqrt(3)) * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
      }
      ctx.closePath();
    } else if (type === 'square') {
      const s = size / Math.sqrt(2);
      ctx.rect(-s / 2, -s / 2, s, s);
    }
    ctx.stroke();
    ctx.restore();
  }

  function getMatches(key) {
    const map = {};
    for (const f of sealFigures) map[f[key]] = (map[f[key]] || 0) + 1;
    return Object.values(map);
  }

  function checkRarity() {
    const colorMatch = Math.max(...getMatches('color'));
    const typeMatch = Math.max(...getMatches('type'));

    if (colorMatch === 4 && typeMatch === 4) {
      ethereal++; seal += 1;
      showRareMessage('✨ Ethereal Seal!', CHANCES.ethereal);
      return 'ethereal';
    }
    if (colorMatch === 3 && typeMatch === 3) {
      legendary++; seal += 0.1;
      showRareMessage('🔥 Legendary Seal!', CHANCES.legendary);
      return 'legendary';
    }
    if (colorMatch === 4 || typeMatch === 4) {
      mythic++; seal += 0.01;
      showRareMessage('💎 Mythic Seal!', CHANCES.mythic);
      return 'mythic';
    }
    if (colorMatch === 3 || typeMatch === 3) {
      rare++; seal += 0.001;
      showRareMessage('🌟 Rare Seal!', CHANCES.rare);
      return 'rare';
    }
    showRareMessage('', '');
    return 'common';
  }

  function showRareMessage(title, chance) {
    if (title) {
      rareMessageEl.innerHTML = `${title}<br><span style="font-size:13px;">Chance: ${chance}</span>`;
      rareMessageEl.classList.add('active');
      setTimeout(() => rareMessageEl.classList.remove('active'), 2500);
    } else {
      rareMessageEl.textContent = '';
      rareMessageEl.classList.remove('active');
    }
    updateSeal();
    updateProfileStats && updateProfileStats();
  }

  function generateRandomSeal() {
    sealFigures = [];
    for (let i = 0; i < 4; i++) {
      const type = figureTypes[Math.floor(Math.random() * figureTypes.length)];
      const color = colors[Math.floor(Math.random() * colors.length)];
      const size = sizeRange[Math.floor(Math.random() * sizeRange.length)];
      const speed = rotationSpeeds[Math.floor(Math.random() * rotationSpeeds.length)];
      const direction = Math.random() < 0.5 ? 1 : -1;
      sealFigures.push({ type, color, size, speed, direction, rotation: 0 });
    }
    statTotal++;
    checkRarity();
  }

  let time = 0;
  function render() {
    const {size, dpr} = resizeCanvas();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const cx = canvas.width / 2, cy = canvas.height / 2;
    const scale = size / 520 * dpr;
    const glowPulse = 0.75 + 0.25 * Math.sin(time * Math.PI * 2 / 3);
    for (let i = 0; i < sealFigures.length; i++) {
      const f = sealFigures[i];
      f.rotation += f.speed * f.direction;
      drawShape(ctx, f.type, cx, cy, f.size * scale, f.color, f.rotation, glowPulse, dpr);
    }
    time += 1 / 60;
    requestAnimationFrame(render);
  }

  function updateSphereCount() {
    document.getElementById('sphere-count').textContent = spheres;
  }

  function gainXP(amount) {
    xp += amount;
    while (xp >= 100) {
      xp -= 100;
      level++;
    }
    xpEl.textContent = xp;
    levelEl.textContent = level;
    if (profileLevelEl) profileLevelEl.textContent = level;
  }

  function updateSeal() {
    sealBalanceEl.textContent = seal.toFixed(3);
  }

  function updateProfileStats() {
    if (!rareStatsEl) return;
    rareStatsEl.innerHTML = `
      <li>Всего генераций: <span>${statTotal}</span></li>
      <li>🌟 Rare: <span>${rare}</span> <span style="color:#00ff88;font-size:13px;">(${CHANCES.rare})</span></li>
      <li>💎 Mythic: <span>${mythic}</span> <span style="color:#00ff88;font-size:13px;">(${CHANCES.mythic})</span></li>
      <li>🔥 Legendary: <span>${legendary}</span> <span style="color:#00ff88;font-size:13px;">(${CHANCES.legendary})</span></li>
      <li>✨ Ethereal: <span>${ethereal}</span> <span style="color:#00ff88;font-size:13px;">(${CHANCES.ethereal})</span></li>
      <li>Баланс $SEAL: <span>${seal.toFixed(3)}</span></li>
    `;
  }

  function onClick() {
    if (spheres <= 0) return alert('Сферы закончились!');
    spheres--; updateSphereCount(); generateRandomSeal(); gainXP(1);
  }

  container.addEventListener('click', onClick);
  container.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      onClick();
    }
  });

  window.openTab = id => {
    document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  };
  window.closeTabs = () => {
    document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
    closeMockPayment && closeMockPayment();
  };

  document.getElementById('avatar-btn').onclick = () => openTab('profile-tab');

  const modal = document.getElementById('mock-payment-modal');
  const confirmBtn = document.getElementById('confirm-payment-btn');
  const result = document.getElementById('mock-payment-result');
  const amountEl = document.getElementById('mock-payment-amount');
  let amount = 0;
  window.startMockPayment = amt => {
    amount = amt;
    amountEl.textContent = amt;
    modal.style.display = 'block';
    result.textContent = '';
    confirmBtn.disabled = false;
  };
  window.closeMockPayment = () => {
    modal.style.display = 'none';
    result.textContent = '';
    confirmBtn.disabled = false;
  };
  confirmBtn.onclick = () => {
    confirmBtn.disabled = true;
    result.textContent = 'Обработка платежа...';
    setTimeout(() => {
      spheres += amount;
      updateSphereCount();
      result.textContent = `Успешно куплено ${amount} сфер!`;
      confirmBtn.disabled = false;
    }, 1500);
  };

  function updateMiningBtn() {
    const now = Math.floor(Date.now()/1000);
    if (miningCooldown > now) {
      miningBtn.disabled = true;
      let left = miningCooldown - now;
      let h = Math.floor(left/3600);
      let m = Math.floor((left%3600)/60);
      let s = left%60;
      miningBtn.textContent = `Mining: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    } else {
      miningBtn.disabled = false;
      miningBtn.textContent = 'Mining';
    }
  }
  miningBtn.onclick = () => {
    if (miningBtn.disabled) return;
    miningCooldown = Math.floor(Date.now()/1000) + 12*3600;
    seal += 0.10;
    updateSeal();
    updateMiningBtn();
  };
  setInterval(updateMiningBtn, 1000);

  resizeCanvas();
  generateRandomSeal();
  updateSphereCount();
  updateSeal();
  updateProfileStats();
  updateMiningBtn();
  render();
})();
</script>
</body>
</html>
